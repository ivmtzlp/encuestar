#' Esta es la clase Encuesta
#' @description La clase Encuesta contiene todos los metodos, y atributos que puede tener una encuesta.
#' @field respuestas Base de datos de respuestas
#' @field muestra Base de datos de muestra.
#' @field dicionario Base de datos de diccionario
#' @export
#' @import dplyr ggplot2 tidyr sf purrr stringr

Encuesta <- R6::R6Class("Encuesta",
                        public = list(
                          respuestas = NULL,
                          quitar_vars = NULL,
                          cuestionario=NULL,
                          muestra = NULL,
                          auditoria_telefonica=NA,
                          bd_correcciones = NULL,
                          Graficas = NULL,
                          shp_completo = NULL,
                          shp = NULL,
                          tipo_encuesta = NULL,
                          mantener = NULL,
                          auditoria = NULL,
                          patron = NA,
                          auditar = NA,
                          sin_peso = NA,
                          rake = NA,
                          mantener_falta_coordenadas = NULL,
                          n_simulaciones = NA,
                          dir_app = NULL,
                          #' @description
                          #' Create a person
                          #' @param respuestas Name of the person
                          #' @param diccionario Hair colour
                          initialize = function(respuestas = NA,
                                                n_simulaciones = 100,
                                                quitar_vars = NA,
                                                muestra = NA,
                                                auditoria_telefonica = NA,
                                                bd_correcciones = NULL,
                                                cuestionario=NA,
                                                shp = NA,
                                                tipo_encuesta = NA,
                                                mantener = NA,
                                                patron = NA,
                                                auditar = NA,
                                                sin_peso = F,
                                                rake = T,
                                                mantener_falta_coordenadas = F,
                                                dir_app = "auditoria"
                          ) {
                            sf_use_s2(F)
                            tipo_encuesta <- match.arg(tipo_encuesta,c("inegi","ine"))
                            self$sin_peso <- sin_peso
                            self$quitar_vars <- quitar_vars
                            self$rake <- rake
                            self$tipo_encuesta <- tipo_encuesta
                            self$patron <- patron
                            self$auditar <- auditar
                            self$mantener_falta_coordenadas <- mantener_falta_coordenadas
                            self$n_simulaciones <- if("logical" %in% class(respuestas)) n_simulaciones else 0
                            # Valorar si no es mejor un active binding
                            un <- muestra$niveles %>% filter(nivel == muestra$ultimo_nivel)
                            nivel <- un %>% unite(nivel, tipo, nivel) %>% pull(nivel)
                            var_n <- un %>% pull(variable)

                            # Valorar active binding
                            self$cuestionario <- Cuestionario$new(documento = cuestionario, patron)
                            # Valorar active binding
                            self$auditoria_telefonica <- auditoria_telefonica %>% distinct(SbjNum, .keep_all = T)

                            # Base de respuestas incorrectas y su correccion
                            self$bd_correcciones <- bd_correcciones

                            self$shp_completo <- shp

                            self$shp <- shp$shp %>% purrr::pluck(var_n) %>%
                              inner_join(muestra$muestra %>% purrr::pluck(var_n) %>% unnest(data) %>%
                                           distinct(!!rlang::sym(var_n) := !!rlang::sym(var_n), !!rlang::sym(nivel)))
                            self$mantener <- mantener
                            # Respuestas

                            if(!"data.frame" %in% class(respuestas)){ respuestas <- self$simular_surveytogo(cuestionario = self$cuestionario,
                                                                                                            n = self$n_simulaciones,
                                                                                                            diseño = muestra,
                                                                                                            shp = shp)
                            }
                            self$respuestas <- Respuestas$new(base = respuestas %>% mutate(cluster_0 = SbjNum),
                                                              encuesta = self,
                                                              mantener_falta_coordenadas = self$mantener_falta_coordenadas,
                                                              muestra_completa = muestra,
                                                              patron = patron,
                                                              nivel = nivel, var_n = var_n
                            )

                            # Muestra (recalcula fpc)
                            self$muestra <- Muestra$new(muestra = muestra, respuestas = self$respuestas$base,
                                                        nivel = nivel, var_n = var_n)

                            # Informacion muestral
                            self$respuestas$vars_diseno(muestra = self$muestra, var_n = var_n, tipo_encuesta = self$tipo_encuesta)
                            # Diseno
                            self$muestra$extraer_diseno(respuestas = self$respuestas$base,
                                                        marco_muestral = self$muestra$muestra$poblacion$marco_muestral,
                                                        tipo_encuesta = self$tipo_encuesta,
                                                        sin_peso = self$sin_peso,
                                                        rake = self$rake)

                            print(paste0("La base de campo contiene ", as.character(nrow(respuestas)), " filas"))
                            print(paste0("La base de eliiminadas contiene ", as.character(nrow(self$auditoria_telefonica)), " filas"))
                            print(paste0("La base de entrevistas efectivas contiene ", as.character(nrow(self$muestra$diseno$variables)), " filas"))

                            #Preguntas
                            self$Graficas <- Graficas$new(encuesta = self, diseno = NULL, diccionario = NULL, tema = encuestar:::tema_default())

                            # Shiny app de auditoria
                            self$dir_app <- dir_app
                            self$auditoria <- Auditoria$new(self, tipo_encuesta = self$tipo_encuesta, dir = self$dir_app)
                            file.copy(overwrite = FALSE,
                                      from = system.file("constantes_y_funciones/constantes.R",
                                                         package = "encuestar",
                                                         mustWork = TRUE),
                                      to = "R")
                            source(file = paste0(getwd(), "/R/constantes.R"))
                            beepr::beep()
                            return(print(match_dicc_base(self, self$quitar_vars), n = Inf))
                          },

                          simular_surveytogo = function(cuestionario, n, diseño, shp){
                            #simular respuestas
                            respuestas <- cuestionario$diccionario %>% mutate(n = n) %>%
                              pmap_dfc(function(llaves, respuestas, tipo_pregunta, n,...){
                                if(tipo_pregunta == "numericas") {
                                  aux_r <- respuestas[1] %>%
                                    str_split(pattern = "-") %>%
                                    pluck(1) %>%
                                    as.numeric()

                                  respuestas <- seq(aux_r[1], aux_r[2]) %>%
                                    as.character() %>%
                                    c(respuestas[2])
                                }

                                tibble(llaves = sample(respuestas,size = n, replace = T)) %>%
                                  set_names(llaves)
                              })
                            #ubicación aleatoria en muestra
                            secc <- diseño$poblacion$marco_muestral %>%
                              semi_join(diseño$muestra$MZA %>%
                                          distinct(cluster_2),
                                        by = "cluster_2") %>%
                              distinct(cluster_2,SECCION)

                            respuestas <- shp$shp$SECCION %>%
                              semi_join(secc) %>%
                              st_sample(size = n) %>%
                              st_coordinates() %>%
                              as_tibble %>%
                              sf::st_as_sf(coords = c("X","Y"), crs = "+init=epsg:4326") %>%
                              st_join(shp$shp$SECCION) %>%
                              select(SECCION) %>%
                              left_join(secc) %>%
                              transmute(SECCION = as.character(cluster_2)) %>%
                              bind_cols(st_coordinates(.)) %>%
                              as_tibble() %>% select(-geometry) %>% rename(Longitude = X, Latitude = Y) %>% bind_cols(respuestas) %>%
                              tibble::rownames_to_column(var = "SbjNum") %>% mutate(SbjNum = as.numeric(SbjNum))
                            #simular sexo y edad para postestratificación
                            respuestas <- respuestas %>%
                              mutate(sexo = sample(c("Hombre", "Mujer"),
                                                   size = n, replace = T),
                                     edad = sample(18:100,size = n, replace = T))
                            #formato de base
                            respuestas <- respuestas %>%
                              mutate(Srvyr = NA,
                                     Date = sample(x = seq(from = lubridate::today(),
                                                           to = lubridate::today() + lubridate::days(3),
                                                           by = "days"),
                                                   size = nrow(respuestas),
                                                   replace = T),
                                     INT15 = NA,
                                     T_Q = NA)

                            respuestas <- respuestas %>%
                              relocate(Srvyr, Date, .before = Longitude) %>%
                              relocate(SECCION, INT15, .after = Latitude)
                          },

                          error_muestral_maximo = function(quitar_patron = NULL){
                            aux <- self$cuestionario$diccionario %>% filter(tipo_pregunta == "multiple")
                            if(!is.null(quitar_patron)) {
                              quitar_patron <- paste(quitar_patron, collapse = "|")
                              aux <- aux %>% filter(!grepl(quitar_patron, x = llaves))
                            }

                            aux <- aux %>% mutate(n = map_int(respuestas,~length(.x)))
                            aux <- aux %>%
                              pull(llaves) %>% map_df(~{
                                # nas <- self$respuestas$base %>% summarise(any(is.na(c_across(.x)))) %>% pull(1)
                                survey::svymean(survey::make.formula(.x), design = self$muestra$diseno, na.rm = T) %>%
                                  tibble::as_tibble(rownames = "respuesta") %>%
                                  # rename(SE = 3) %>%
                                  mutate(pregunta = .x,
                                         # tiene_na = !!nas,
                                         # respuesta = stringr::str_replace(string = respuesta,
                                         #                                  pattern = as.character(.x),
                                         #                                  replacement = "")
                                  ) %>% select(respuesta, mean, SE)
                              }) %>% mutate(SE = qnorm(.95)*SE)

                            labels <- aux %>% summarise(inf = quantile(SE,.25,na.rm = T),
                                                        mid = quantile(SE,.5,na.rm = T),
                                                        sup = quantile(SE,.75,na.rm = T),
                                                        max = max(SE,na.rm = T)
                            ) %>% mutate(iqr_min = inf-1.5*(sup-inf),
                                         iqr_max = sup + 1.5*(sup-inf)) %>%
                              pivot_longer(everything(), names_to = "stat", values_to = "valor")

                            a <- aux %>%
                              ggplot() +
                              geom_boxplot(aes(x = 0, y = SE)) +
                              geom_label(data = labels, aes(x = 0, y = valor, label = scales::percent(valor)),
                                         hjust = 0, vjust = 0, nudge_x = .01) + labs(x = NULL) +
                              scale_y_continuous(labels = scales::percent_format(1))

                            b <- aux %>% filter(SE >= labels %>% filter(stat == "sup") %>% pull(valor)) %>%
                              ggplot() + geom_col(aes(y = reorder(respuesta, SE), x = SE)) +
                              geom_vline(xintercept = labels %>% filter(stat == "sup") %>% pull(valor))+
                              labs(y = NULL)+
                              scale_x_continuous(labels = scales::percent_format(1))

                            print(a + b)
                            return(aux)
                          },

                          exportar_entregable = function(carpeta = "entregables", agregar = NULL, quitar = NULL){

                            if(!file.exists(carpeta)) dir.create(carpeta)

                            # Exportar bd
                            exportar_bd(self, carpeta, agregar, quitar)

                            # Exportar diccionario
                            self$cuestionario$diccionario %>%
                              unnest(respuestas) %>%
                              readr::write_excel_csv(glue::glue("{carpeta}/diccionario.csv"))

                          }),

                        private=list()
)

#' Esta es la clase Respuestas
#' @export
Respuestas <- R6::R6Class("Respuestas",
                          inherit = Encuesta,
                          public = list(
                            eliminadas = NULL,
                            cluster_corregido = NULL,
                            base = NULL,
                            n=NULL,
                            m=NULL,
                            sin_coordenadas = NULL,
                            mantener_falta_coordenadas = NULL,
                            #' @description
                            #' Crear respuesta
                            #' @param base Base de datos de respuestas.
                            initialize=function(base,
                                                encuesta,
                                                muestra_completa,
                                                mantener_falta_coordenadas,
                                                patron,
                                                nivel, var_n) {
                              shp <- encuesta$shp
                              mantener <- encuesta$mantener
                              diccionario <- encuesta$cuestionario$diccionario

                              if(!identical(names(encuesta$auditoria_telefonica), c("SbjNum", "razon"))) stop("Los nombres de las columnas de la base de datos de auditoría telefónica deben ser: 'Sbjnum, razon'")

                              if(!is.null(encuesta$bd_correcciones)){
                                if(!identical(names(encuesta$bd_correcciones), c("SbjNum", "codigo_pregunta", "capturada", "correccion"))) stop("Los nombres de las columnas de la base de datos de correcciones deben ser: 'Sbjnum, codigo_pregunta, capturada, correccion'")
                              }

                              auditoria_telefonica <- encuesta$auditoria_telefonica
                              bd_correcciones <- encuesta$bd_correcciones
                              muestra <- muestra_completa$muestra %>% purrr::pluck(var_n)

                              self$base <- base

                              # Parar si nombres de respuestas no coinciden con diccionario
                              self$nombres(self$base, diccionario)

                              # Quitar patrones a respuestas
                              self$q_patron(self$base, diccionario, patron)

                              # Parar si opciones de respuesta no coinciden con diccionario
                              self$categorias(self$base, diccionario)

                              # Advertir si hay opciones de respuestas que tienen count = 0
                              self$respuestas_sin_seleccion(bd = self$base, diccionario)

                              # Limpiar las que no pasan auditoria telefonica
                              self$eliminar_auditoria_telefonica(auditoria_telefonica)

                              # Corregir respuestas registradas mal por los encuestadores
                              if(!is.null(bd_correcciones)) {

                                self$base <- self$corregir_respuestas(respuestas = self$base, bd_correcciones = bd_correcciones)

                              }

                              # Mantener respuestas que no tienen coordenadas
                              if(mantener_falta_coordenadas){

                                self$coordenadas_faltantes()

                              } else {

                                # Limpiar las respuestas que no tienen coordenadas
                                self$eliminar_falta_coordenadas()

                              }

                              # Eliminar entrevistas cuyo cluster no pertenece a la muestra
                              self$eliminar_fuera_muestra(self$base, muestra, nivel, var_n)

                              # Corregir cluster equivocado
                              self$correccion_cluster(self$base, shp, mantener, nivel, var_n)

                              # Calcular distancia de la entrevista al cluster correcto
                              self$calcular_distancia(base = self$base,
                                                      encuesta = encuesta,
                                                      muestra = muestra_completa,
                                                      var_n = var_n, nivel = nivel)

                              # Limpiar las que no tienen variables de diseno
                              # self$eliminar_faltantes_diseno() # no entiendo por qué
                              if(mantener_falta_coordenadas){
                                self$base <- self$base %>% bind_rows(
                                  self$sin_coordenadas
                                )
                              }

                              # Cambiar variables a tipo numerica
                              numericas <- diccionario %>% filter(tipo_pregunta == "numericas") %>%
                                pull(llaves)

                              self$base <- self$base %>%
                                mutate(across(all_of(numericas), ~readr::parse_number(.x)))

                              # self$eliminadas <- anti_join(base, self$base, by = "SbjNum")
                            },

                            nombres = function(bd, diccionario){

                              faltantes <- is.na(match(diccionario$llaves, names(bd)))
                              if(!all(!faltantes)){
                                stop(glue::glue("Las siguientes variables no se encuentran en la base de datos: {paste(diccionario$llaves[faltantes], collapse = ', ')}"))
                              }

                            },

                            q_patron = function(bd, dicc, patron){
                              if(!is.na(patron)){
                                aux <- bd %>%
                                  mutate(across(c(all_of(dicc$llaves),where(is.character)),
                                                ~stringr::str_squish(gsub(x = .x,pattern = patron, ""))))
                                self$base <- aux
                              }
                            },

                            categorias = function(bd, diccionario){

                              discrepancia <- diccionario %>%
                                filter(tipo_pregunta == "multiples", !grepl("_otro", llaves)) %>%
                                pull(llaves) %>%
                                map_df(~{

                                  res <- bd %>%
                                    count(across(all_of(.x))) %>%
                                    na.omit %>%
                                    pull(1)

                                  m <- match(res, diccionario %>%
                                               filter(llaves == .x) %>%
                                               unnest(respuestas) %>%
                                               pull(respuestas)
                                  )

                                  tibble(llave = .x,
                                         faltantes = res[is.na(m)]
                                  )

                                })

                              if(nrow(discrepancia)>0){

                                warning(paste("La siguiente tabla muestra las respuestas en la base de campo que no están contempladas en el cuestionario de procesamiento", " (total: ", nrow(discrepancia), ").", sep = ""),
                                        immediate. = T)
                                print(discrepancia |>
                                        rename(codigo_pregunta = llave,
                                               respuesta_campo = faltantes))
                                warning("Revise las respuestas entre la base de campo y el cuestionario de procesamiento y corrija.",
                                        immediate. = T)

                              }

                            },

                            respuestas_sin_seleccion = function(bd, diccionario){

                              bd_sinregistros <- diccionario |>
                                filter(tipo_pregunta == "multiples", !grepl("_otro", llaves)) |>
                                pull(llaves) %>%
                                purrr::map_df(.x = ., .f = ~ {

                                  respuestas_sin_registros <- diccionario %>%
                                    filter(llaves == .x) %>%
                                    unnest(respuestas) |>
                                    pull(respuestas) |>
                                    as_tibble() |>
                                    anti_join(bd |>
                                                count(across(all_of(.x))) %>%
                                                arrange(1) |>
                                                pull(1) |>
                                                as_tibble(), by = "value") |>
                                    pull()

                                  tibble(codigo_pregunta = .x,
                                         respuesta_sin_registros = respuestas_sin_registros)

                                })

                              if(nrow(bd_sinregistros) > 0) {

                                warning(paste("La siguiente tabla muestra las respuestas que tienen cero registros en la base de respuestas de campo", " (total: ", nrow(bd_sinregistros), ").", sep = ""),
                                        immediate. = T)
                                print(bd_sinregistros, n = Inf)

                              }

                            },

                            eliminar_auditoria_telefonica = function(auditoria_telefonica){

                              if(("SbjNum" %in% names(self$base)) &
                                 ("SbjNum" %in% names(auditoria_telefonica))){
                                if(is.character(auditoria_telefonica$SbjNum)) auditoria_telefonica <- auditoria_telefonica %>% mutate(SbjNum = readr::parse_double(SbjNum))
                                # Se eliminan por no pasar la auditoria telefonica
                                n <- nrow(self$base)

                                self$eliminadas <- self$base %>% inner_join(auditoria_telefonica, by = "SbjNum")

                                self$base <- self$base %>%
                                  anti_join(auditoria_telefonica, by="SbjNum")

                                # Mandar mensaje
                                print(
                                  glue::glue("Se eliminaron {n-nrow(self$base)} encuestas por auditoria telefonica")
                                )
                              }
                              else cat("Identificador SbjNum no presente en alguna de las bases para eliminar por auditoria telefonica")
                              return(self$base)

                            },

                            corregir_respuestas = function(respuestas, bd_correcciones){

                              corregir_respuestas_fn <- function(bd_respuestas, id_entrevista, codigo_pregunta, respuesta_capturada, respuesta_correcta) {

                                respuestas_corregidas <- bd_respuestas %>%
                                  mutate(!!rlang::sym(codigo_pregunta) := dplyr::if_else(condition = SbjNum == id_entrevista,
                                                                                         true = respuesta_correcta,
                                                                                         false = !!rlang::sym(codigo_pregunta)))

                                return(respuestas_corregidas)

                              }

                              for(i in seq_along(bd_correcciones$SbjNum)) {

                                # print(i)

                                id_entrevista = bd_correcciones$SbjNum[i]
                                codigo_pregunta = bd_correcciones$codigo_pregunta[i]
                                respuesta_capturada = bd_correcciones$capturada[i]
                                respuesta_correcta = bd_correcciones$correccion[i]

                                a <- respuestas |>
                                  filter(SbjNum == id_entrevista) |>
                                  select(!!codigo_pregunta) |>
                                  pull()

                                # print(a)

                                respuestas <- corregir_respuestas_fn(bd_respuestas = respuestas,
                                                                     id_entrevista = id_entrevista,
                                                                     codigo_pregunta = codigo_pregunta,
                                                                     respuesta_capturada = respuesta_capturada,
                                                                     respuesta_correcta = respuesta_correcta)

                                b <- respuestas |>
                                  filter(SbjNum == id_entrevista) |>
                                  select(!!codigo_pregunta) |>
                                  pull()

                                # print(b)

                              }

                              return(respuestas)

                            },

                            coordenadas_faltantes = function(){

                              self$sin_coordenadas <- self$base %>% filter(is.na(Longitude) | is.na(Latitude))
                              self$base <- self$base %>% filter(!is.na(Longitude) | !is.na(Latitude))

                            },

                            eliminar_falta_coordenadas = function(){

                              if("Longitude" %in% names(self$base) & "Latitude" %in% names(self$base)){
                                n <- nrow(self$base)
                                self$base <- self$base %>% filter(!is.na(Longitude) | !is.na(Latitude))
                                self$eliminadas <- self$eliminadas %>% bind_rows(
                                  self$base %>% filter(is.na(Longitude) | is.na(Latitude)) %>% mutate(razon = "Sin coordenadas")
                                )
                                print(
                                  glue::glue("Se eliminaron {n-nrow(self$base)} encuestas por falta de coordenadas")
                                )
                              } else{
                                print("No existe la columna Longitude ni Latitude en la base de respuestas")
                              }
                            },

                            correccion_cluster = function(base, shp, mantener, nivel, var_n){

                              aux <- corregir_cluster(base, shp, mantener, nivel, var_n)

                              self$cluster_corregido <- self$base %>%
                                select(all_of(c("SbjNum", "Srvyr", "Date", "Longitude", "Latitude", var_n))) %>%
                                anti_join(aux, by = c("SbjNum", var_n)) %>%
                                left_join(aux %>% select(all_of(c("SbjNum", var_n))), by = "SbjNum") %>%
                                rename(anterior = 6, nueva = 7)

                              self$base <- aux
                            },

                            eliminar_fuera_muestra = function(respuestas, muestra, nivel, var_n){

                              self$base <- respuestas %>%
                                semi_join(muestra %>% mutate(!!rlang::sym(nivel) := as.character(!!rlang::sym(nivel))),
                                          by = set_names(nivel,var_n))

                              self$eliminadas <- self$eliminadas %>% bind_rows(
                                respuestas %>%
                                  anti_join(muestra %>% mutate(!!rlang::sym(nivel) := as.character(!!rlang::sym(nivel))),
                                            by = set_names(nivel,var_n)) %>%
                                  mutate(razon = "Cluster no existente")
                              )
                              print(glue::glue("Se eliminaron {nrow(respuestas) - nrow(self$base)} entrevistas ya que el cluster no pertenece a la muestra"))
                            },

                            calcular_distancia = function(base, encuesta, muestra, var_n, nivel){

                              aux_sf <- base %>% st_as_sf(coords = c("Longitude", "Latitude"),crs = 4326)

                              pol <- dist_poligonos(aux_sf, shp = encuesta$shp, var_n, nivel)
                              puntos <- dist_puntos(aux_sf, encuesta, muestra, var_n, nivel)

                              if(nrow(puntos) > 0){
                                respuestas <- pol %>%
                                  anti_join(
                                    puntos %>% as_tibble, by = "SbjNum"
                                  ) %>% bind_rows(
                                    puntos
                                  )
                              } else {
                                respuestas <- pol
                              }

                              self$base <- respuestas %>% left_join(base %>% select(SbjNum, Longitude, Latitude), by = "SbjNum")
                            },

                            eliminar_faltantes_diseno = function(){
                              n <- nrow(self$base)

                              self$base <- self$base %>%
                                filter(
                                  across(
                                    .cols = c(starts_with("id_"),
                                              starts_with("fpc_"),
                                              starts_with("prob_"),
                                              starts_with("pob_")),
                                    .fns = ~ !is.na(.x)
                                  ))
                              print(
                                glue::glue("Se eliminaron {n-nrow(self$base)} encuestas por tener datos faltantes en las variables de diseno muestral")
                              )
                              return(self$base)
                            },

                            vars_diseno = function(muestra, var_n, tipo_encuesta){
                              vars_join <- c(var_n,
                                             names(muestra$base)[is.na(match(names(muestra$base), names(self$base)))]
                              )

                              self$base <- self$base %>%
                                inner_join(muestra$base %>% select(all_of(vars_join)))

                              if(tipo_encuesta == "inegi"){
                                self$base <- self$base %>%
                                  mutate(rango_edad = as.character(cut(as.integer(edad),c(17, 24, 59, 200),
                                                                       c("18A24","25A59","60YMAS"))),
                                         sexo = if_else(sexo == "Mujer", "F", "M"))
                              }

                              if(tipo_encuesta == "ine"){
                                self$base <- self$base %>%
                                  mutate(rango_edad = cut(as.numeric(edad), c(17,24,39,59,Inf),
                                                          labels = c("18A24","25A39","40A59","60YMAS")),
                                         sexo = if_else(sexo == "Mujer", "F", "M"))
                              }

                              if(sum(grepl("region", muestra$muestra$niveles$variable)) > 0){
                                var_reg <- muestra$muestra$niveles %>% filter(variable == "region") %>%
                                  unite("var_reg", c(tipo, nivel)) %>% pull(var_reg)
                                self$base <- self$base %>%
                                  inner_join(muestra$muestra$poblacion$marco_muestral %>%
                                               distinct(across(all_of(var_reg)), region), by = var_reg)
                              }
                            }

                          )
)


#'Esta es la clase de muestra
#'@export
Muestra <- R6::R6Class("Muestra",
                       public=list(
                         muestra = NULL,
                         base=NULL,
                         diseno_original = NULL,
                         region = NULL,
                         calibracion = NULL,
                         diseno=NULL,
                         calibraciones = NULL,
                         initialize =function(muestra, respuestas, nivel, var_n){
                           self$muestra <- muestra

                           self$base <- muestra$muestra %>% purrr::pluck(var_n)
                           self$recalcular_fpc(respuestas = respuestas, nivel, var_n)
                         },
                         recalcular_fpc = function(respuestas, nivel, var_n){

                           var_pob <- self$muestra$variable_poblacional

                           pob <- self$base %>%
                             tidyr::unnest(data) %>%
                             count(!!rlang::sym(nivel), wt= !!rlang::sym(var_pob), name="poblacion") %>%
                             mutate(!!rlang::sym(var_n) := as.character(!!rlang::sym(nivel))) %>%
                             select(-!!rlang::sym(nivel))

                           respuesta_fpc <- respuestas %>%
                             count(!!rlang::sym(var_n)) %>%
                             left_join(pob, by= var_n) %>%
                             mutate(fpc_0=n/poblacion) %>%
                             select(!!rlang::sym(var_n), fpc_0)

                           muestra <- self$base %>%
                             mutate(data = map(data,~.x %>% distinct(across(contains("fpc"))))) %>%
                             tidyr::unnest(data) %>%
                             select(-fpc_0) %>%
                             mutate(!!rlang::sym(var_n) := as.character(!!rlang::sym(nivel))) %>%
                             inner_join(respuesta_fpc, by= var_n)

                           self$base <- muestra

                         },
                         extraer_diseno = function(respuestas, marco_muestral, tipo_encuesta, sin_peso, rake){
                           if(sin_peso){
                             self$diseno <- survey::svydesign(
                               ids=~1,
                               data = respuestas
                             )
                           } else{
                             r <- try(
                               survey::svydesign(
                                 pps="brewer",
                                 ids=crear_formula_nombre(respuestas, "cluster_"),
                                 fpc = crear_formula_nombre(respuestas, "fpc_"),
                                 strata = crear_formula_nombre(respuestas, "strata_"),
                                 data = respuestas
                               )
                               ,T)

                             diseno <- if("try-error" %in% class(r)){
                               message("Se intenta muestreo estratificado por estrato. Faltan unidades a muestrear.")
                               out <- survey::svydesign(
                                 pps="brewer",
                                 ids = ~1,
                                 strata = crear_formula_nombre(respuestas, "strata_"),
                                 data = respuestas
                               )
                               out
                             } else{
                               r
                             }

                             if(rake){
                               if(tipo_encuesta == "inegi"){
                                 pob <- marco_muestral %>%
                                   transmute(
                                     P_18A24_F,
                                     P_18A24_M,
                                     P_25A59_F = P_18YMAS_F - P_18A24_F - P_60YMAS_F,
                                     P_25A59_M = P_18YMAS_M - P_18A24_M - P_60YMAS_M,
                                     P_60YMAS_F, P_60YMAS_M) %>%
                                   summarise(across(everything(), ~sum(.x,na.rm = T))) %>%
                                   pivot_longer(everything()) %>% mutate(name = gsub("P_","",name)) %>%
                                   separate(name, into = c("rango_edad", "sexo"))
                               }

                               if(tipo_encuesta == "ine"){
                                 pob <- marco_muestral %>%
                                   select(contains("LN22_")) %>%
                                   summarise(across(everything(), ~sum(.x,na.rm = T))) %>%
                                   pivot_longer(everything()) %>% mutate(name = gsub("LN22_","",name)) %>%
                                   separate(name, into = c("rango_edad", "sexo"))
                               }


                               pobG <- pob %>% count(rango_edad, wt = value, name = "Freq")
                               pobS<- pob %>% count(sexo, wt = value, name = "Freq")
                               self$diseno <- survey::rake(diseno, list(~rango_edad, ~sexo), list(pobG, pobS))
                             } else{
                               self$diseno <- diseno
                             }
                           }

                         },
                         revisar_sexo = function(){
                           self$diseno$variables %>% count(sexo) %>%
                             mutate(pct =n/sum(n), tipo = "encesta") %>% bind_rows(
                               self$muestra$poblacion$marco_muestral %>%
                                 select(contains("LN22_")) %>%
                                 summarise(across(everything(), ~sum(.x,na.rm = T))) %>%
                                 pivot_longer(everything()) %>% mutate(name = gsub("LN22_","",name)) %>%
                                 separate(name, into = c("rango_edad", "sexo")) %>%
                                 count(sexo, wt = value) %>%
                                 mutate(pct = n/sum(n), tipo = "real")
                             ) %>% ggplot(aes(x = tipo, y = pct, color = sexo)) + geom_point() +
                             ggrepel::geom_text_repel(aes(label = paste0(scales::percent(pct,.01))),force_pull = 5) +
                             geom_line(aes(group = sexo)) +
                             scale_y_continuous(labels = scales::percent) +
                             labs(y = NULL,  x = NULL) +
                             theme_minimal()
                         },
                         revisar_rango_edad = function(){
                           self$diseno$variables %>% count(rango_edad) %>%
                             mutate(pct = n/sum(n), tipo = "encuesta") %>% bind_rows(
                               self$muestra$poblacion$marco_muestral %>%
                                 select(contains("LN22_")) %>%
                                 summarise(across(everything(), ~sum(.x,na.rm = T))) %>%
                                 pivot_longer(everything()) %>% mutate(name = gsub("LN22_","",name)) %>%
                                 separate(name, into = c("rango_edad", "sexo")) %>%
                                 count(rango_edad, wt = value )%>%
                                 mutate(pct = n/sum(n), tipo = "real")
                             ) %>% ggplot(aes(x = tipo, y = pct, color = rango_edad)) + geom_point() +
                             ggrepel::geom_text_repel(aes(label = paste0(scales::percent(pct,.01))),force_pull = 5) +
                             geom_line(aes(group = rango_edad)) +
                             scale_y_continuous(labels = scales::percent) +
                             labs(y = NULL,  x = NULL) +
                             theme_minimal()
                         },
                         diseno_region = function(seleccion){
                           self$region <- seleccion

                           if(is.null(self$diseno_original)){
                             self$diseno_original <- self$diseno
                           }

                           self$diseno <- subset(self$diseno_original, region %in% self$region)
                         },
                         regresar_diseno_original = function(){
                           self$region <- NULL
                           self$calibracion <- NULL
                           self$diseno_original -> self$diseno
                         },
                         agregar_calibracion = function(vars, poblacion, nombre){
                           calibracion <- survey::calibrate(self$diseno,
                                                            survey::make.formula(vars),
                                                            population = poblacion)

                           self$calibraciones <- self$calibraciones |>
                             append(
                               list(
                                 list(
                                   diseno = calibracion,
                                   variables = vars
                                 )
                               ) |>
                                 purrr::set_names(nombre))
                         },
                         revisar_calibracion = function(nombre){
                           aux <- self$calibraciones |> purrr::pluck(nombre)
                           survey::svytotal(survey::make.formula(aux |> pluck("variables")),
                                            design = aux |> pluck("diseno"))
                         },
                         comparar_calibraciones = function(variables, valor_variables, vartype){
                           list(original = self$diseno) |>
                             append(self$calibraciones |> purrr::map(~.x$diseno)) |>
                             encuestar:::comparar_disenos(variables, valor_variables, vartype)
                         },
                         elegir_calibracion = function(nombre){

                           self$calibracion <- nombre

                           if(is.null(self$diseno_original)){
                             self$diseno_original <- self$diseno
                           }

                           self$diseno <- self$calibraciones |> purrr:::pluck(nombre, "diseno")
                         }
                       ))

#'Esta es la clase cuestionario
#'@export
#'
Cuestionario <- R6::R6Class("Cuestionario",
                            public=list(
                              documento=NULL,
                              aprobado=NULL,
                              diccionario=NULL,
                              initialize=function(documento, patron){
                                if("data.frame" %in% class(documento)){
                                  self$diccionario <- documento
                                } else{
                                  self$documento <- documento %>% officer::docx_summary() %>% as_tibble
                                  self$diccionario <- private$crear_diccionario(patron)
                                }
                              },
                              aprobar=function(){
                                self$aprobado <- T
                                return(invisible(self))
                              },
                              checar_pregunta=function(pregunta){
                                pregunta_chr <- rlang::expr_text(ensym(pregunta))
                                bd <- self$diccionario %>%
                                  filter(llaves==pregunta_chr)
                                pertenece <- (nrow(bd)==1)
                                if(pertenece){
                                  return(map(bd,~.x))
                                }
                                else return(NULL)
                              },
                              resumen = function(){

                                res <- resumen_cuestionario(self$diccionario)

                                return(res)

                              }
                            )
                            ,
                            private=list(
                              crear_diccionario=function(patron){
                                diccionario <- diccionario_cuestionario(self$documento, patron)
                                return(diccionario)

                              })
)

#'Esta es la clase de Graficas
#'@export
#'
Graficas <- R6::R6Class(classname = "Graficas",
                        public = list(
                          encuesta = NULL,
                          diseno = NULL,
                          diccionario = NULL,
                          Descriptiva = NULL,
                          Regiones = NULL,
                          Modelo = NULL,
                          Cruce = NULL,
                          Especial = NULL,
                          Tendencias = NULL,
                          tema = NULL,
                          graficadas = NULL,
                          initialize = function(encuesta, diseno, diccionario, tema = encuestar:::tema_default()){

                            self$encuesta <- encuesta

                            self$diseno <- diseno
                            if(!is.null(self$encuesta)){

                              self$diccionario <- self$encuesta$cuestionario$diccionario

                            } else {

                              self$diccionario <- diccionario

                            }

                            self$tema <- tema

                            self$Descriptiva <- Descriptiva$new(encuesta = self$encuesta,
                                                                diseno = self$diseno,
                                                                diccionario = self$diccionario,
                                                                tema = self$tema,
                                                                graficadas = self$graficadas)

                            self$Cruce <- Cruce$new(encuesta = self$encuesta,
                                                    diseno = self$diseno,
                                                    diccionario = self$diccionario,
                                                    tema = self$tema,
                                                    graficadas = self$graficadas)

                            self$Especial <- Especial$new(encuesta = self$encuesta,
                                                          diseno = self$diseno,
                                                          diccionario = self$diccionario,
                                                          tema = self$tema,
                                                          graficadas = self$graficadas)

                            self$Tendencias <- Tendencias$new(encuesta = self$encuesta)

                            if(!is.null(self$encuesta)) {

                              self$Regiones <- Regiones$new(encuesta = self$encuesta,
                                                            diccionario = self$encuesta$cuestionario$diccionario,
                                                            tema = self$tema)

                              self$Modelo <- Modelo$new(diseno = self$encuesta$muestra$diseno,
                                                        diccionario = self$encuesta$cuestionario$diccionario,
                                                        tema = self$tema,
                                                        graficadas = self$graficadas)

                            } else {

                              self$Regiones <- NULL
                              self$Modelo <- Modelo$new(diseno = self$diseno,
                                                        diccionario = self$diccionario,
                                                        tema = self$tema,
                                                        graficadas = self$graficadas)

                            }
                          },
                          faltantes = function(){
                            gant_p_r(self$encuesta$cuestionario$diccionario %>% filter(!llaves %in% self$graficadas))
                          }
                        )
)

#'Esta es la clase de Grafica
#'@export
#'
Descriptiva <- R6::R6Class(classname = "Descriptiva",
                           public = list(
                             encuesta = NULL,
                             diseno = NULL,
                             diccionario = NULL,
                             tema = NULL,
                             graficadas = NULL,
                             initialize = function(encuesta = NULL, diseno = NULL, diccionario = NULL, tema, graficadas = NULL){
                               self$encuesta <- encuesta
                               self$diseno <- diseno
                               self$diccionario <- diccionario
                               self$tema <- tema
                               self$graficadas <- graficadas
                             },
                             gauge_numerica = function(codigo, color = "#850D2D", escala = c(0, 10), size_text_pct = 14){

                               llave_aux <- codigo
                               if(!(llave_aux %in% self$graficadas)){
                                 if(llave_aux %in% self$diccionario$llaves){
                                   self$graficadas <- self$graficadas %>% append(llave_aux)
                                 } else {
                                   stop(glue::glue("La llave {llave_aux} no existe en el diccionario"))
                                 }
                               } else {
                                 warning(glue::glue("La llave {llave_aux} ya fue graficada con anterioridad"))
                               }

                               if(is.null(self$diseno)) {

                                 diseno <- self$encuesta$muestra$diseno

                               } else {

                                 diseno <- self$diseno

                               }

                               bd_estimacion <- encuestar:::analizar_frecuencias(diseno = diseno, pregunta = {{codigo}})

                               tema <- self$diccionario |>
                                 filter(llaves == rlang::ensym(codigo)) |>
                                 pull(tema)

                               bd_estimacion |>
                                 mutate(tema = tema) |>
                                 encuestar:::graficar_gauge(color_principal = color,
                                                            escala = escala,
                                                            size_text_pct = size_text_pct)

                             },
                             gauge_categorica = function(codigo, filtro, color = "#850D2D", escala = c(0, 1), size_text_pct = 14){

                               if(is.null(filtro)) {

                                 stop(paste("Especifique la respuesta en la cual hacer filtro con el argumento `filtro`"))

                               }

                               else {

                                 llave_aux <- codigo
                                 if(!(llave_aux %in% self$graficadas)){
                                   if(llave_aux %in% self$diccionario$llaves){
                                     self$graficadas <- self$graficadas %>% append(llave_aux)
                                   } else {
                                     stop(glue::glue("La llave {llave_aux} no existe en el diccionario"))
                                   }
                                 } else {
                                   warning(glue::glue("La llave {llave_aux} ya fue graficada con anterioridad"))
                                 }

                                 if(is.null(self$diseno)) {

                                   diseno <- self$encuesta$muestra$diseno

                                 } else {

                                   diseno <- self$diseno

                                 }

                                 bd_estimacion <- encuestar:::analizar_frecuencias(diseno = diseno, pregunta = {{codigo}}) |>
                                   filter(eval(rlang::parse_expr(filtro)))

                                 tema <- self$diccionario |>
                                   filter(llaves == rlang::ensym(codigo)) |>
                                   pull(tema)

                                 bd_estimacion %>%
                                   mutate(tema = tema) |>
                                   encuestar:::graficar_gauge(color_principal = color,
                                                              escala = escala,
                                                              size_text_pct = size_text_pct)
                               }

                             },
                             barras_categorica = function(codigo, salto = 20, porcentajes_fuera = F, desplazar_porcentajes = 0, pct_otros = 0.01, orden_respuestas = NA){

                               llave_aux <- codigo
                               if(!(llave_aux %in% self$graficadas)){
                                 if(llave_aux %in% self$diccionario$llaves){
                                   self$graficadas <- self$graficadas %>% append(llave_aux)
                                 } else {
                                   stop(glue::glue("La llave {llave_aux} no existe en el diccionario"))
                                 }
                               } else {
                                 warning(glue::glue("La llave {llave_aux} ya fue graficada con anterioridad"))
                               }

                               tema <- self$diccionario |>
                                 filter(llaves == rlang::ensym(codigo)) |>
                                 pull(tema)

                               if(is.null(self$diseno)) {

                                 diseno <- self$encuesta$muestra$diseno

                               } else {

                                 diseno <- self$diseno

                               }

                               encuestar:::analizar_frecuencias(diseno = diseno, pregunta = {{codigo}}) |>
                                 mutate(tema = tema) |>
                                 mutate(respuesta = forcats::fct_lump_min(f = respuesta, min = pct_otros, w = media, other_level = "Otros"),
                                        respuesta = dplyr::if_else(condition = respuesta == "Otro", true = "Otros", false = respuesta)) %>%
                                 group_by(respuesta) |>
                                 summarise(media = sum(media)) |>
                                 encuestar:::graficar_barras(salto = salto,
                                                             porcentajes_fuera = porcentajes_fuera,
                                                             desplazar_porcentajes = desplazar_porcentajes,
                                                             orden_respuestas = orden_respuestas) +
                                 self$tema

                             },
                             barras_numerica = function(patron_inicial, aspectos = NULL, salto = 20, filtro = NULL, porcentajes_fuera = F, desplazar_porcentajes = 0){

                               # llave_aux <- paste(patron_inicial, aspectos, sep = "_")

                               # llaves_aux %>%
                               # purrr::walk(.x = ., .f = ~ print(paste(.x, "hola", sep = "")))
                               # comprobar_variableGraficada = function(variable, variablesGraficadas, variablesDiccionario) {
                               #
                               #   if(!(variable %in% variablesGraficadas)) {
                               #     if(variable %in% variablesDiccionario) {
                               #       variablesGraficadas <- variablesGraficadas %>% append(variable)
                               #     }
                               #     else {
                               #       stop(glue::glue("La llave {variable} no existe en el diccionario"))
                               #     }
                               #   }
                               #   else {
                               #     warning(glue::glue("La llave {variable} ya fue graficada con anterioridad"))
                               #   }
                               # }
                               # comprobar_variableGraficada(variable = "candidato_preferencia", variablesGraficadas = self$graficadas, variablesDiccionario = self$diccionario$llaves)

                               # if(!(llave_aux %in% self$graficadas)){
                               #   if(llave_aux %in% self$diccionario$llaves){
                               #     self$graficadas <- self$graficadas %>% append(llave_aux)
                               #   } else {
                               #     stop(glue::glue("La llave {llave_aux} no existe en el diccionario"))
                               #   }
                               # } else {
                               #   warning(glue::glue("La llave {llave_aux} ya fue graficada con anterioridad"))
                               # }

                               if(is.null(filtro) | is.null(aspectos)) {

                                 stop(paste("Especifique la respuesta en la cual hacer filtro con el argumento `filtro` o indique los aspectos correctos."))

                               } else {

                                 tema <- self$diccionario |>
                                   filter(llaves == rlang::ensym(patron_inicial)) |>
                                   pull(pregunta)

                                 if(is.null(self$diseno)) {

                                   diseno <- self$encuesta$muestra$diseno

                                 } else {

                                   diseno <- self$diseno

                                 }

                                 bd_estimacion <- encuestar:::analizar_frecuencias_aspectos(diseno = diseno,
                                                                                            diccionario = self$diccionario,
                                                                                            patron_pregunta = {{patron_inicial}},
                                                                                            aspectos = aspectos) |>
                                   left_join(self$diccionario |> select(llaves, tema), by = c("aspecto" = "llaves")) |>
                                   filter(eval(rlang::parse_expr(filtro))) |>
                                   transmute(respuesta = tema, media)

                                 bd_estimacion |>
                                   encuestar:::graficar_barras(salto = salto,
                                                               porcentajes_fuera = porcentajes_fuera,
                                                               desplazar_porcentajes = desplazar_porcentajes,
                                                               orden_respuestas = NA) +
                                   self$tema +
                                   theme(legend.position = "none",
                                         axis.text.x = element_text(size = 14),
                                         plot.caption = element_text(size = 12))

                               }

                             },
                             barras_multirespuesta = function(patron_inicial, salto = 20, porcentajes_fuera = F, desplazar_porcentajes = 0){

                               if(is.null(self$diseno)) {

                                 diseno <- self$encuesta$muestra$diseno

                               } else {

                                 diseno <- self$diseno

                               }

                               encuestar:::analizar_frecuencia_multirespuesta(diseno = diseno,
                                                                              patron_inicial) %>%
                                 encuestar:::graficar_barras(salto = salto,
                                                             porcentajes_fuera = porcentajes_fuera,
                                                             desplazar_porcentajes = desplazar_porcentajes) +
                                 self$tema

                             },
                             barras_texto = function(){},
                             intervalo_numerica = function(patron, aspectos, escala = c(0, 10), point_size = 1, text_point_size = 8){

                               # llave_aux <- codigo
                               # if(!(llave_aux %in% self$graficadas)){
                               #   if(llave_aux %in% self$diccionario$llaves){
                               #     self$graficadas <- self$graficadas %>% append(llave_aux)
                               #   } else {
                               #     stop(glue::glue("La llave {llave_aux} no existe en el diccionario"))
                               #   }
                               # } else {
                               #   warning(glue::glue("La llave {llave_aux} ya fue graficada con anterioridad"))
                               # }

                               if(is.null(self$diseno)) {

                                 diseno <- self$encuesta$muestra$diseno

                               } else {

                                 diseno <- self$diseno

                               }

                               encuestar:::analizar_frecuencias_aspectos(diseno = diseno,
                                                                         diccionario = self$diccionario,
                                                                         patron_pregunta = {{patron}},
                                                                         aspectos = aspectos) %>%
                                 left_join(self$diccionario %>%
                                             select(aspecto = llaves, tema), by = "aspecto") |>
                                 encuestar:::graficar_intervalo_numerica(escala = escala, point_size = point_size, text_point_size = text_point_size) +
                                 self$tema


                             }
                           ))

#'Esta es la clase de Cruce
#'@export
#'
Cruce <- R6::R6Class(classname = "Cruce",
                     public = list(
                       encuesta = NULL,
                       diseno = NULL,
                       diccionario = NULL,
                       tema = NULL,
                       graficadas = NULL,
                       initialize = function(encuesta = NULL, diseno = NULL, diccionario = NULL, tema, graficadas = NULL){
                         self$encuesta <- encuesta
                         self$diseno <- diseno
                         self$diccionario <- diccionario
                         self$tema <- tema
                         self$graficadas <- graficadas
                       },
                       sankey_categorica = function(variables = NULL, colores, size_text_cat = 6, omitir_valores_variable1 = NULL, omitir_valores_variable2 = NULL){

                         if(is.null(variables)) {

                           stop(paste("Especifique las variables a analizar con el argumento `variables`"))

                         } else {

                           if(is.null(self$diseno)) {

                             diseno <- self$encuesta$muestra$diseno

                           } else {

                             diseno <- self$diseno

                           }

                           bd_estimacion <- encuestar:::analizar_sankey(diseno = diseno,
                                                                        variables = variables,
                                                                        filtro_var1 = omitir_valores_variable1,
                                                                        filtro_var2 = omitir_valores_variable2)

                           encuestar:::graficar_sankey(bd = bd_estimacion,
                                                       variables = variables,
                                                       colores = colores,
                                                       size_text_cat = size_text_cat)
                         }
                       },
                       puntos = function(cruce, variables, vartype = "se", valor_variables){

                         if(is.null(self$diseno)) {

                           diseno <- self$encuesta$muestra$diseno

                         } else {

                           diseno <- self$diseno

                         }

                         bd_estimacion <- encuestar:::analizar_crucePuntos(diseno = srvyr::as_survey_design(diseno),
                                                                           cruce = cruce, variables = variables,vartype = vartype,
                                                                           valor_variables = valor_variables) |>
                           left_join(self$diccionario |>
                                       distinct(llaves, tema), by = c("variable" = "llaves")) |>
                           select(!variable) |>
                           rename(variable = tema)

                         encuestar:::graficar_crucePuntos(bd = bd_estimacion, cruce = cruce, vartype = vartype) +
                           self$tema

                       },
                       puntosMultiples = function(variablePrincipal, variablesSecundarias, valor_variblesSecundarias, orden_variablePrincipal, invertirVariables = F, vartype = "cv") {
                         if(is.null(self$diseno)) {

                           diseno <- self$encuesta$muestra$diseno

                         } else {

                           diseno <- self$diseno

                         }

                         bd_estimacion <- encuestar:::analizar_crucePuntos(diseno = srvyr::as_survey_design(diseno),
                                                                           cruce = variablePrincipal,
                                                                           variables = variablesSecundarias,
                                                                           vartype = vartype,
                                                                           valor_variables = valor_variblesSecundarias) |>
                           left_join(self$diccionario |>
                                       distinct(llaves, tema), by = c("variable" = "llaves")) |>
                           select(!variable) |>
                           rename("variablePrincipal" := variablePrincipal)

                         bd_estimacion <-
                           if(invertirVariables) {
                             bd_estimacion |>
                               transmute(aux = variablePrincipal,
                                         variablePrincipal = tema,
                                         tema = aux,
                                         mean,
                                         cv) |>
                               select(!aux)
                           } else {
                             bd_estimacion
                           }

                         bd_estimacion |>
                           encuestar:::graficar_cruce_puntosMultiples(orden_variablePrincipal) +
                           self$tema

                       },
                       brechasDuales = function(var1, var2_filtro, filtro, vartype = "cv", line_rich = FALSE, line_linewidth = 2, line_hjust = "ymax", line_vjust = -0.3){

                         if(is.null(self$diseno)) {

                           diseno <- self$encuesta$muestra$diseno

                         } else {

                           diseno <- self$diseno

                         }

                         encuestar:::analizar_cruceBrechas(diseno = srvyr::as_survey_design(diseno),
                                                           var1 = var1,
                                                           var2_filtro = var2_filtro,
                                                           filtro = filtro,
                                                           vartype = vartype) |>
                           encuestar:::graficar_cruce_brechasDuales(var1 = var1,var2_filtro = var2_filtro, vartype = vartype,
                                                                    line_rich = line_rich,
                                                                    line_linewidth = line_linewidth,
                                                                    line_hjust = line_hjust,
                                                                    line_vjust = line_vjust) +
                           self$tema
                       },
                       brechasMultiples = function(por_grupo, variables, vartype = "cv", valor_variables, line_rich = FALSE, line_linewidth = 2, line_hjust = "ymax", line_vjust = -0.3){

                         if(is.null(self$diseno)) {

                           diseno <- self$encuesta$muestra$diseno

                         } else {

                           diseno <- self$diseno

                         }

                         encuestar:::analizar_crucePuntos(srvyr::as_survey_design(diseno),
                                                          cruce = por_grupo,
                                                          variables = variables, vartype = vartype, valor_variables = valor_variables) %>%
                           {
                             if(vartype == "cv"){
                               mutate(., pres=case_when(`cv` >.15 & `cv` <.30 ~ "*",
                                                        `cv` >.30 ~ "**",
                                                        TRUE ~""))
                             } else {
                               .
                             }
                           } |>
                           left_join(self$diccionario,
                                     join_by(variable == llaves)) |> select(-variable) |>
                           rename(variable = tema) %>%
                           encuestar:::graficar_cruce_brechasMultiples(cruce = por_grupo, vartype = vartype,
                                                                       line_rich = line_rich,
                                                                       line_linewidth = line_linewidth,
                                                                       line_hjust = line_hjust,
                                                                       line_vjust = line_vjust) +
                           self$tema

                       },
                       barrasMultiples = function(por_grupo, variables, vartype = "cv", valor_variables, color = "green", filter = NULL){

                         if(is.null(self$diseno)) {

                           diseno <- self$encuesta$muestra$diseno

                         } else {

                           diseno <- self$diseno

                         }

                         encuestar:::analizar_crucePuntos(srvyr::as_survey_design(diseno),
                                                          cruce = por_grupo,
                                                          variables = variables, vartype = vartype,
                                                          valor_variables = valor_variables) %>%
                           {
                             if(vartype == "cv"){
                               mutate(., pres=case_when(`cv` >.15 & `cv` <.30 ~ "*",
                                                        `cv` >.30 ~ "**",
                                                        TRUE ~""))
                             } else{
                               .
                             }
                           } |>
                           left_join(self$diccionario,
                                     join_by(variable == llaves)) |> select(-variable) |>
                           rename(variable = tema) |>
                           encuestar:::graficar_cruce_barrasMultiples(cruce = por_grupo,
                                                                      vartype = vartype,
                                                                      color = color,
                                                                      filter = filter) +
                           self$tema

                       },
                       bloques = function(cruce, variable, vartype = "cv", filter = NULL, linea_grosor = 2, linea_color = "white"){

                         if(is.null(self$diseno)) {

                           diseno <- self$encuesta$muestra$diseno

                         } else {

                           diseno <- self$diseno

                         }

                         encuestar:::analizar_cruceBrechas(srvyr::as_survey_design(diseno),
                                                           var1 = cruce,
                                                           var2_filtro = variable,
                                                           filtro = filter,
                                                           vartype = vartype) |>
                           graficar_cruce_bloques(cruce = cruce,
                                                  variable = variable,
                                                  vartype = vartype,
                                                  filter = filter,
                                                  linea_grosor = linea_grosor,
                                                  linea_color = linea_color) +
                           self$tema
                       }
                     ))

#'Esta es la clase de Especial
#'@export
#'
Especial <- R6::R6Class(classname = "Especial",
                        public = list(
                          encuesta = NULL,
                          diseno = NULL,
                          diccionario = NULL,
                          tema = NULL,
                          graficadas = NULL,
                          initialize = function(encuesta = NULL, diseno = NULL, diccionario = NULL, tema, graficadas = NULL){
                            self$encuesta <- encuesta
                            self$diseno <- diseno
                            self$diccionario <- diccionario
                            self$tema <- tema
                            self$graficadas <- graficadas
                          },
                          candidatoOpinion = function(patron_inicial,
                                                      aspectos,
                                                      ns_nc = "Ns/Nc",
                                                      regular = "Regular",
                                                      llave_burbuja = NA,
                                                      filtro_burbuja = "respuesta == 'Sí'",
                                                      grupo_positivo,
                                                      grupo_negativo,
                                                      orden_resp,
                                                      colores_opinion = c("red", "yellow", "green"),
                                                      color_nsnc = "gray70",
                                                      color_burbuja = "blue",
                                                      caption_opinion = "",
                                                      caption_nsnc = "Ns/Nc",
                                                      caption_burbuja = "Conocimiento",
                                                      size_caption_opinion = 12,
                                                      size_caption_nsnc = 14,
                                                      size_caption_burbuja = 14,
                                                      size_text_cat = 16,
                                                      size_pct = 12,
                                                      burbuja = T,
                                                      salto = 20,
                                                      salto_respuestas = 100,
                                                      mostrar_nsnc = T,
                                                      orden_cat = NULL){

                            if(is.null(self$diseno)) {

                              diseno <- self$encuesta$muestra$diseno

                            } else {

                              diseno <- self$diseno

                            }

                            if(!is.na(llave_burbuja)){

                              bd_burbuja <- encuestar::analizar_frecuencias_aspectos(diseno = diseno,
                                                                                     diccionario = self$diccionario,
                                                                                     patron_pregunta = llave_burbuja,
                                                                                     aspectos = aspectos) %>%
                                filter(eval(rlang::parse_expr(filtro_burbuja))) %>%
                                left_join(self$diccionario %>% select(aspecto = llaves, tema))
                            } else {
                              bd_burbuja <- NA
                            }

                            encuestar:::analizar_frecuencias_aspectos(diseno = diseno,
                                                                      diccionario = self$diccionario,
                                                                      patron_pregunta = patron_inicial,
                                                                      aspectos = aspectos) |>
                              left_join(self$diccionario %>% select(aspecto = llaves, tema)) %>%
                              encuestar:::graficar_candidato_opinion(ns_nc = ns_nc,
                                                                     regular = regular,
                                                                     grupo_positivo= grupo_positivo,
                                                                     grupo_negativo = grupo_negativo,
                                                                     caption_opinion = caption_opinion,
                                                                     caption_nsnc = caption_nsnc,
                                                                     caption_burbuja = caption_burbuja,
                                                                     size_caption_opinion = size_caption_opinion,
                                                                     size_caption_nsnc = size_caption_nsnc,
                                                                     size_caption_burbuja = size_caption_burbuja,
                                                                     size_text_cat = size_text_cat,
                                                                     size_pct = size_pct,
                                                                     orden_resp = orden_resp,
                                                                     colores = colores_opinion,
                                                                     color_nsnc = color_nsnc,
                                                                     burbuja = bd_burbuja,
                                                                     color_burbuja = color_burbuja,
                                                                     salto = salto,
                                                                     tema = self$tema,
                                                                     mostrar_nsnc = mostrar_nsnc,
                                                                     salto_respuestas = salto_respuestas,
                                                                     orden_cat = orden_cat,
                                                                     patron_inicial = patron_inicial)

                          },
                          candidatoOpinion2 = function(patron_opinion,
                                                       aspectos,
                                                       ns_nc = "Ns/Nc",
                                                       regular = "Regular",
                                                       patron_conocimiento,
                                                       filtro_conocimiento = "respuesta == 'Sí'",
                                                       orden_opinion,
                                                       etiquetas = c("Candidato", "Opinión"),
                                                       colores_opinion = c("red", "yellow", "green"),
                                                       colores_candidato = colores_candidato,
                                                       color_principal = "#BF498A",
                                                       color_conocimiento = "blue",
                                                       size_text_header = 18,
                                                       size_text_body = 14,
                                                       salto = 20,
                                                       salto_respuestas = 100){

                            if(is.null(self$diseno)) {

                              diseno <- self$encuesta$muestra$diseno

                            } else {

                              diseno <- self$diseno

                            }

                            encuestar:::calcular_tabla_candidatoOpinion(diseno = diseno,
                                                                        diccionario = self$diccionario,
                                                                        patron_opinion = patron_opinion,
                                                                        patron_conocimiento = patron_conocimiento,
                                                                        aspectos = aspectos,
                                                                        filtro_conocimiento = filtro_conocimiento,
                                                                        orden_opinion = orden_opinion,
                                                                        ns_nc = ns_nc,
                                                                        salto_respuestas = salto_respuestas) %>%
                              encuestar:::formatear_tabla_candidatoOpinion(orden_opinion = orden_opinion,
                                                                           etiquetas = etiquetas,
                                                                           colores_opinion = colores_opinion,
                                                                           color_principal = color_principal,
                                                                           colores_candidato = colores_candidato,
                                                                           size_text_header = size_text_header,
                                                                           size_text_body = size_text_body,
                                                                           salto = salto)

                          },
                          candidatoPartido = function(llave_partido, llave_conocimiento, respuesta_conoce, candidatos, corte_otro, cliente, colores_candidatos, colores_partido){

                            if(is.null(self$diseno)) {

                              diseno <- self$encuesta$muestra$diseno

                            } else {

                              diseno <- self$diseno

                            }

                            encuestar:::analizar_candidatoPartido(diseno = diseno,
                                                                  diccionario = self$diccionario,
                                                                  llave_partido = llave_partido,
                                                                  llave_conocimiento = llave_conocimiento,
                                                                  respuesta_conoce = respuesta_conoce,
                                                                  candidatos = candidatos,
                                                                  corte_otro = corte_otro) %>%
                              purrr::map(~.x %>%
                                           left_join(self$diccionario %>% select(aspecto = llaves, tema))
                              ) %>%
                              encuestar:::graficar_candidatoPartido(cliente = cliente,
                                                                    tipo_conoce = "intervalos",
                                                                    colores_candidato = colores_candidatos,
                                                                    colores_partido = colores_partido,
                                                                    solo_respondidos = T,
                                                                    tema = self$tema)
                          },
                          candidatoSaldo = function(llave_opinion, candidatos, positivos, negativos, color_positivo = "green", color_negativo = "red"){

                            if(is.null(self$diseno)) {

                              diseno <- self$encuesta$muestra$diseno

                            } else {

                              diseno <- self$diseno

                            }

                            bd_saldo <- encuestar:::analizar_saldoOpinion(diseno = diseno,
                                                                          diccionario = self$diccionario,
                                                                          llave_opinion = llave_opinion,
                                                                          candidatos = candidatos,
                                                                          grupo_positivo = positivos,
                                                                          grupo_negativo = negativos)

                            encuestar:::graficar_candidatoSaldo(bd = bd_saldo,
                                                                grupo_positivo = positivos,
                                                                grupo_negativo = negativos,
                                                                color_positivo = color_positivo,
                                                                color_negativo = color_negativo) +
                              self$tema

                          },
                          metodo_morena = function(personajes, atributos){
                            if(is.null(self$diseno)) {

                              diseno <- self$encuesta$muestra$diseno

                            } else {

                              diseno <- self$diseno

                            }
                            encuestar:::analizar_morena(diseno = diseno, diccionario = self$diccionario, personajes = personajes, atributos = atributos) %>%
                              encuestar:::graficar_morena(personajes = personajes, atributos = atributos)
                          },
                          tabla_votoCruzado = function(var1,
                                                       var2,
                                                       filtro_var2 = NULL,
                                                       etiquetas = c("variable 1", "variable 2"),
                                                       colores_var1,
                                                       colores_var2,
                                                       size_text_header = 18,
                                                       size_text_body = 14,
                                                       salto = 20){

                            if(is.null(self$diseno)) {

                              diseno <- self$encuesta$muestra$diseno

                            } else {

                              diseno <- self$diseno

                            }

                            # if(is.null(filtro_var2)) {
                            #   filtro_var2 <-
                            #     diseno$variables |>
                            #     as_tibble() |>
                            #     distinct(!!rlang::sym(var2)) |>
                            #     pull()
                            # }

                            bd_votoCruzado <-
                              encuestar:::calcular_tabla_votoCruzado(diseno = diseno,
                                                                     var1 = var1,
                                                                     var2 = var2,
                                                                     filtro_var2 = filtro_var2)

                            tabla_salida <-
                              encuestar:::formatear_tabla_votoCruzado(tabla_votoCruzado = bd_votoCruzado,
                                                                      var1 = var1,
                                                                      var2 = var2,
                                                                      filtro_var2 = filtro_var2,
                                                                      etiquetas = etiquetas,
                                                                      colores_var1 = colores_var1,
                                                                      colores_var2 = colores_var2,
                                                                      size_text_header = size_text_header,
                                                                      size_text_body = size_text_body,
                                                                      salto = salto)

                            return(tabla_salida)
                          }
                        ))

#'Esta es la clase de Regiones
#'@export
#'
Regiones <- R6::R6Class(classname = "Regiones",
                        public = list(
                          encuesta = NULL,
                          diseno = NULL,
                          diccionario = NULL,
                          tema = NULL,
                          shp_regiones = NULL,
                          initialize = function(encuesta = NULL, diseno = NULL, diccionario = NULL, tema){
                            self$encuesta <- encuesta
                            self$diseno <- diseno
                            self$diccionario <- diccionario
                            self$tema <- tema
                            self$crear_shp_regiones()
                          },
                          mapa_ganador = function(variable, lugar = 1){

                            if(is.null(self$diseno)) {

                              diseno <- self$encuesta$muestra$diseno

                            } else {

                              diseno <- self$diseno

                            }

                            encuestar:::calcular_ganadorRegion(diseno = diseno,
                                                               regiones = self$shp,
                                                               variable = {{variable}},
                                                               lugar = lugar) %>%
                              encuestar:::graficar_mapaRegiones(variable = {{variable}})
                          },
                          mapa_degradadoNumerico = function(variable){

                            if(is.null(self$diseno)) {

                              diseno <- self$encuesta$muestra$diseno

                            } else {

                              diseno <- self$diseno

                            }

                            encuestar:::analizar_frecuenciasRegion(regiones = self$shp,
                                                                   variable = {{variable}},
                                                                   diseno = diseno) %>%
                              encuestar:::graficar_mapaRegiones(variable = {{variable}}, categorica = F)
                          },
                          heatmap_conocimiento = function(patron_llaveConocimiento, candidatos, respuesta, ordenRegiones = NULL, salto_labelRegiones = 5){

                            if(is.null(self$diseno)) {

                              diseno <- self$encuesta$muestra$diseno

                            } else {

                              diseno <- self$diseno

                            }

                            bd_analizar_conocimientoRegion <- encuestar:::analizar_conocimientoRegion(patron_llaveConocimiento = patron_llaveConocimiento,
                                                                                                      aspectos_llaveConocimiento = candidatos,
                                                                                                      filtro_respuestaConocimiento = respuesta,
                                                                                                      diseno = diseno,
                                                                                                      diccionario = self$diccionario)
                            encuestar:::graficar_conocimientoRegion(bd = bd_analizar_conocimientoRegion, ordenRegiones = ordenRegiones, salto_labelRegiones = salto_labelRegiones)
                          },
                          heatmap_saldoOpinion = function(patron_llaveOpinion, candidatos, ns_nc, cat_negativo, cat_regular, cat_positivo,
                                                          ordenRegiones = NULL, salto_labelRegiones = 5){

                            if(is.null(self$diseno)) {

                              diseno <- self$encuesta$muestra$diseno

                            } else {

                              diseno <- self$diseno

                            }

                            encuestar:::analizar_saldoRegion(patron_llaveOpinion = patron_llaveOpinion, aspectos_llaveOpinion = candidatos, ns_nc = ns_nc, cat_negativo = cat_negativo, cat_regular = cat_regular, cat_positivo = cat_positivo, diseno = diseno, diccionario = self$diccionario) %>%
                              encuestar:::graficar_saldoRegion(ordenRegiones = ordenRegiones, salto_labelRegiones = salto_labelRegiones)

                          },
                          mapa_resaltarRegion = function(region, color){
                            self$shp_regiones %>%
                              mutate(color = dplyr::if_else(condition = region %in% !!region,
                                                            true = color,
                                                            false = "gray70")) %>%
                              ggplot(aes(fill = color), color = "black") +
                              geom_sf() +
                              scale_fill_identity() +
                              theme_void() +
                              labs(tit = region)
                          },
                          crear_shp_regiones = function(){
                            sf_use_s2(T)
                            self$shp_regiones <-
                              self$encuesta$shp_completo$shp$SECCION %>%
                              left_join(self$encuesta$muestra$muestra$poblacion$marco_muestral %>%
                                          distinct(SECCION, region), by = "SECCION") %>%
                              group_by(region) %>%
                              summarise(n()) %>%
                              sf::st_buffer(dist = 0)
                            sf_use_s2(F)
                          },
                          resaltar_region = function(color){
                            if(is.null(self$encuesta$muestra$region)){
                              stop("Correr clase$muestra$diseno_region para indicar la region seleccionada")
                            }
                            self$encuesta$Graficas$Regiones$shp_regiones |>
                              mutate(color = if_else(region %in% self$encuesta$muestra$region, color, "gray70")) %>%
                              ggplot(aes(fill = color)) +
                              geom_sf(color = "black") +
                              scale_fill_identity() +
                              theme_void() +
                              labs(tit = self$encuesta$muestra$region)
                          }
                        ))

#'Esta es la clase de Tendencias
#'@export
#'
Tendencias <- R6::R6Class(classname = "Tendencias",
                          public = list(
                            encuesta = NULL,
                            bd_resultados = NULL,
                            initialize = function(encuesta = NULL){
                              self$encuesta <- encuesta
                              self$bd_resultados <- self$encuesta$respuestas$base |>
                                mutate(peso = weights(self$encuesta$muestra$diseno))
                            },
                            intencion_voto = function(variable, valores_interes, colores, sin_peso = T){
                              bd_mediaMovil <-
                                encuestar:::calcular_mediaMovil(bd_resultados = self$bd_resultados,
                                                                variable = variable,
                                                                sin_peso = sin_peso,
                                                                valores_interes = valores_interes) |>
                                rename(pct = !!rlang::sym(paste0("movil_", variable)))
                              g <-
                                bd_mediaMovil |>
                                ggplot(aes(x = hora, y = pct, color = !!rlang::sym(variable))) +
                                geom_point(size = 3) +
                                geom_line(linewidth = 1, show.legend = F) +
                                labs(subtitle = "Intención de voto", color = "") +
                                scale_x_datetime(date_breaks = "1 days",
                                                 labels = scales::date_format("%B %d")) +
                                scale_y_continuous(labels = scales::percent) +
                                scale_color_manual(values = colores) +
                                tema_default() +
                                theme(panel.grid.major.y = element_line(colour = "#C5C5C5",
                                                                        linetype = "dotted"))
                              return(g)
                            },
                            conocimiento = function(variables, colores, sin_peso = T, valores_interes = "Sí"){
                              bd_mediaMovil <-
                                encuestar:::calcular_mediaMovil(bd_resultados = self$bd_resultados,
                                                                variable = variables[1],
                                                                sin_peso = sin_peso,
                                                                valores_interes = valores_interes) |>
                                left_join(encuestar:::calcular_mediaMovil(bd_resultados = self$bd_resultados,
                                                                          variable = variables[2],
                                                                          sin_peso = sin_peso,
                                                                          valores_interes = valores_interes),
                                          by = "hora") |>
                                tidyr::pivot_longer(cols = c(paste0("movil_", variables[1]),
                                                             paste0("movil_", variables[2])),
                                                    names_to = "variable",
                                                    values_to = "pct")

                              g <-
                                bd_mediaMovil |>
                                ggplot(aes(x = hora, y = pct, color = variable)) +
                                geom_point(size = 3) +
                                geom_line(linewidth = 1, show.legend = F) +
                                labs(subtitle = "Conocimiento", color = "") +
                                scale_color_manual(values = purrr::set_names(colores[1:2], paste0("movil_", variables)),
                                                   labels = purrr::set_names(variables, paste0("movil_", variables))) +
                                scale_x_datetime(date_breaks = "1 days",
                                                 labels = scales::date_format("%B %d")) +
                                scale_y_continuous(labels = scales::percent) +
                                tema_default() +
                                theme(panel.grid.major.y = element_line(colour = "#C5C5C5",
                                                                        linetype = "dotted"))
                              return(g)
                            },
                            intencion_voto_region = function(variable, valores_interes, colores, sin_peso = T, variable_region = "region"){
                              bd_mediaMovil <-
                                encuestar:::calcular_mediaMovil_region(bd_resultados = self$bd_resultados,
                                                                       variable = variable,
                                                                       sin_peso = sin_peso,
                                                                       valores_interes = valores_interes,
                                                                       variable_region = variable_region) |>
                                rename(pct = !!rlang::sym(paste0("movil_", variable)))
                              g <-
                                bd_mediaMovil |>
                                ggplot(aes(x = hora, y = pct, color = !!rlang::sym(variable))) +
                                geom_point(size = 3) +
                                geom_line(linewidth = 1, show.legend = F) +
                                labs(subtitle = "Intención de voto", color = "") +
                                scale_x_datetime(date_breaks = "1 days",
                                                 labels = scales::date_format("%B %d")) +
                                scale_y_continuous(labels = scales::percent) +
                                scale_color_manual(values = colores) +
                                tema_default() +
                                theme(panel.grid.major.y = element_line(colour = "#C5C5C5",
                                                                        linetype = "dotted")) +
                                facet_wrap(as.formula(paste0("~", variable_region)))
                              return(g)
                            },
                            conocimiento_region = function(variables, colores, sin_peso = T, valores_interes = "Sí", variable_region = "region"){
                              bd_mediaMovil <-
                                encuestar:::calcular_mediaMovil_region(bd_resultados = self$bd_resultados,
                                                                       variable = variables[1],
                                                                       sin_peso = sin_peso,
                                                                       valores_interes = valores_interes,
                                                                       variable_region = variable_region) |>
                                left_join(encuestar:::calcular_mediaMovil_region(bd_resultados = self$bd_resultados,
                                                                                 variable = variables[2],
                                                                                 sin_peso = sin_peso,
                                                                                 valores_interes = valores_interes,
                                                                                 variable_region = variable_region),
                                          by = c("hora", variable_region)) |>
                                tidyr::pivot_longer(cols = c(paste0("movil_", variables[1]),
                                                             paste0("movil_", variables[2])),
                                                    names_to = "variable",
                                                    values_to = "pct")

                              g <-
                                bd_mediaMovil |>
                                ggplot(aes(x = hora, y = pct, color = variable)) +
                                geom_point(size = 3) +
                                geom_line(linewidth = 1, show.legend = F) +
                                labs(subtitle = "Conocimiento", color = "") +
                                scale_color_manual(values = purrr::set_names(colores[1:2], paste0("movil_", variables)),
                                                   labels = purrr::set_names(variables, paste0("movil_", variables))) +
                                scale_x_datetime(date_breaks = "1 days",
                                                 labels = scales::date_format("%B %d")) +
                                scale_y_continuous(labels = scales::percent) +
                                tema_default() +
                                theme(panel.grid.major.y = element_line(colour = "#C5C5C5",
                                                                        linetype = "dotted")) +
                                facet_wrap(as.formula(paste0("~", variable_region)))
                              return(g)
                            }
                          ))

#'Esta es la clase de Modelo
#'@export
#'
Modelo <- R6::R6Class(classname = "Modelo",
                      public = list(
                        encuesta = NULL,
                        diseno = NULL,
                        diccionario = NULL,
                        tema = NULL,
                        graficadas = NULL,
                        initialize = function(encuesta = NULL, diseno = NULL, diccionario = NULL, tema, graficadas = NULL){
                          self$encuesta <- encuesta
                          self$diseno <- diseno
                          self$diccionario <- diccionario
                          self$tema <- tema
                          self$graficadas <- graficadas
                        },
                        correspondencia = function(var1, var2, legenda1 = NULL, legenda2 = NULL, colores = NULL){


                          analisis_correspondencia(var1 = var1, var2 = var2, legenda1 = legenda1, legenda2 = legenda2, diseno = self$diseno, colores = colores)
                        },
                        componentesPrincipales = function(variables){


                          pc <- survey::svyprcomp(survey::make.formula(variables),
                                                  design = self$diseno,
                                                  scale=TRUE, scores=TRUE)
                          factoextra::fviz_pca_biplot(pc, geom.ind = "point", labelsize = 2, repel = T)
                        },
                        blackBox = function(vars, stimuli){

                          if(is.null(self$diseno)) {

                            diseno <- self$encuesta$muestra$diseno

                          } else {

                            diseno <- self$diseno

                          }

                          diseno$variables %>%
                            as_tibble() |>
                            analizar_blackbox_1d(vars, stimuli) %>%
                            graficar_blackbox_1d()

                        }
                      ))

#' Title
#'
#' @param encuesta
#' @param dir
#'
#' @return
#' @export
#'
#' @examples
Auditoria <- R6::R6Class("Auditoria",
                         public = list(
                           dir = NULL,
                           initialize = function(encuesta, tipo_encuesta, dir){
                             if(!file.exists(dir)){
                               dir.create(dir)
                             }
                             dir.create(glue::glue("{dir}/data"))
                             readr::write_rds(encuesta$Graficas, glue::glue("{dir}/data/clase_pregunta.rda"))
                             # readr::write_rds(encuesta$muestra$muestra, glue::glue("{dir}/data/diseno.rda"))
                             # readr::write_rds(encuesta$shp_completo, glue::glue("{dir}/data/shp.rda"))
                             # readr::write_excel_csv(encuesta$respuestas$base, glue::glue("{dir}/data/bd.csv"))
                             sf_use_s2(T)
                             mapa_base <- encuesta$shp_completo$shp$MUNICIPIO %>%
                               left_join(encuesta$muestra$muestra$poblacion$marco_muestral %>% distinct(MUNICIPIO,strata_1)) %>%
                               group_by(strata_1) %>% summarise(n()) %>%
                               sf::st_buffer(dist = 0)
                             readr::write_rds(mapa_base, glue::glue("{dir}/data/mapa_base.rda"))

                             enc_shp <- encuesta$respuestas$base %>%
                               filter(!is.na(Longitude) | !is.na(Latitude)) %>%
                               sf::st_as_sf(coords = c("Longitude","Latitude"), crs = "+init=epsg:4326")
                             readr::write_rds(enc_shp, glue::glue("{dir}/data/enc_shp.rda"))
                             # Calcular la relacióin entre cluster y seccion
                             encuesta$muestra$muestra$poblacion$marco_muestral |>
                               distinct(SECCION, cluster_2) |>
                               readr::write_rds(glue::glue("{dir}/data/catalogo_seccion_cluster.rda"))

                             # readr::write_excel_csv(encuesta$respuestas$eliminadas, glue::glue("{dir}/data/eliminadas.csv"))
                             if(tipo_encuesta == "inegi"){
                               file.copy(overwrite = T,
                                         from = system.file("app_inegi/app.R", package = "encuestar",
                                                            mustWork = TRUE),
                                         to = dir

                               )
                             }

                             if(tipo_encuesta == "ine"){
                               file.copy(overwrite = T,
                                         from = system.file("app_ine/app.R", package = "encuestar",
                                                            mustWork = TRUE),
                                         to = dir

                               )
                             }

                             self$dir <- dir
                           },
                           run_app = function(){
                             shiny::shinyAppDir(
                               self$dir
                             )
                           },
                           subir_app = function(...){
                             rsconnect::deployApp(self$dir,...)
                           }
                         ))
